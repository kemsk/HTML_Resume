{% extends "ts_index.html" %}
{% load static %}

<style>
  #viewUserModal .modal-body p {
    text-align: center;
    margin: 10px 0;
  }

  #viewUserModal .modal-body span {
    display: inline-block;
    margin-top: 5px;
    font-weight: 500;
  }
</style>

{% block content %}
<main id="manage-users-content">
  <div class="section-header mb-4 d-flex justify-content-between align-items-center">
    <div class="title-section d-flex align-items-center">
      <i class="fas fa-users-cog icon"></i>
      <b>MANAGE USERS</b>
    </div>

    <!-- Create New User Button -->
    <button class="btn btn-primary" data-bs-toggle="modal" style="width:auto" data-bs-target="#createUserModal">
      <i class="fas fa-plus"></i>
      <b> Create New User</b>
    </button>
  </div>

  <div class="container-fluid">
    <div class="row g-3">
      <!-- Filters Section -->
      <div class="col-m</div>d-7 offset-md-5">
        <form action="{% url 'ts:UserManagement' %}" method="get" class="d-flex gap-2 align-items-center">
          <button type="button" class="outline">Filters:</button>
          <input id="ssio_name" name="ssio_name" type="text" class="outline" placeholder="Search by Name"
            value="{{ request.GET.ssio_name|default:'' }}">
          <input id="ssio_id" name="ssio_id" type="text" class="outline" placeholder="Search Employee ID"
            value="{{ request.GET.ssio_id|default:'' }}">
          <button type="submit" class="outline">Search</button>

          {% if request.GET.ssio_name or request.GET.ssio_id %}
          <a href="{% url 'ts:UserManagement' %}">
            <button type="button" class="btn btn-outline-secondary">Clear</button>
          </a>
          {% endif %}
        </form>
      </div>


      <!-- Table Section -->
      <div class="col-md-12">
        <table id="users-table" class="table mt-3">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Employee Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.ssio_id }}</td>
              <td>{{ user.ssio_lname }}, {{ user.ssio_fname }}</td>
              <td>{{ user.ssio_username }}</td>
              <td>{{ user.ssio_email }}</td>
              <td>{{ user.access_type }}</td>
              <td>
                  <div class="d-flex gap-2">
                  <!-- View Button -->
                  <button 
                    class="btn btn-primary btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#viewUserModal" 
                    onclick="openViewUserModal(this)"
                    data-id="{{ user.ssio_id }}"
                    data-fname="{{ user.ssio_fname }}"
                    data-lname="{{ user.ssio_lname }}"
                    data-username="{{ user.ssio_username }}"
                    data-email="{{ user.ssio_email }}"
                    data-access-type="{{ user.access_type }}">
                    View
                  </button>

                  <!-- Edit Button -->
                  <button class="btn btn-warning btn-sm" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editUserModal" 
                  onclick="openEditUserModal(this)"
                  data-id="{{ user.ssio_id }}"
                  data-fname="{{ user.ssio_fname }}"
                  data-lname="{{ user.ssio_lname }}"
                  data-email="{{ user.ssio_email }}"
                  data-access-type="{{ user.access_type }}">
                  Edit
                </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center">No users found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

<!-- CREATE USER MODAL -->
  <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
      <div class="createUserModal modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createUserModalLabel">
            <i class="fa-solid fa-user-plus"></i> Create New SSIO User
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
            {% endif %}

            <div class="mb-3 row g-3">
              <div class="col-md-6">
                <label for="ssio_fname" class="form-label">First Name:</label>
                <input type="text" name="ssio_fname" id="ssio_fname" required class="form-control" />
              </div>

              <div class="col-md-6">
                <label for="ssio_lname" class="form-label">Last Name:</label>
                <input type="text" name="ssio_lname" id="ssio_lname" required class="form-control" />
              </div>
            </div>


            <div class="mb-3">
              <label for="ssio_email" class="form-label">Email Address:</label>
              <input type="ssio_email" name="ssio_email" id="ssio_email" required class="form-control" />
            </div>

            <div class="mb-3">
              <label for="ssio_username" class="form-label">Username:</label>
              <input type="text" name="ssio_username" id="ssio_username" required class="form-control" />
            </div>


            <div class="mb-3">
              <label for="password" class="form-label">Password:</label>
              <input type="password" name="password" id="password" required class="form-control" />
            </div>

            <div class="mb-3">
              <label for="confirm-password" class="form-label">Confirm Password:</label>
              <input type="password" name="confirm_password" id="confirm-password" required class="form-control" />
            </div>

            <div class="mb-3">
              <label for="access-type" class="form-label">Access Type:</label>
              <select class="form-select" id="access_type" name="access_type" required>
                <option value="">Select Access Type</option>
                <option value="1">Admin</option>
                <option value="2">User</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="ssio_userpin" class="form-label">User Pin:</label>
              <input type="password" name="ssio_userpin" maxlength="6" pattern="\d{6}" inputmode="numeric"
                id="ssio_userpin" required class="form-control" />
            </div>

            <div class="modal-footer d-flex justify-content-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width:auto">Cancel</button>
              <button type="button" class="btn btn-primary" style="width:auto" onclick="user_create()">Add User</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View User Modal -->
  <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewUserModalLabel">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-start">
          <p><span>User ID:</span> <strong id="modal-user-id"></strong></p>
          <p><span>First Name:</span> <strong id="modal-user-fname"></strong></p>
          <p><span>Last Name:</span> <strong id="modal-user-lname"></strong></p>
          <p><span>Username:</span> <strong id="modal-user-username"></strong></p>
          <p><span>Email:</span> <strong id="modal-user-email"></strong></p>
          <p><span>Access Type:</span> <strong id="modal-user-access-type"></strong></p>

          <button 
            class="btn btn-danger btn-sm" 
            onclick="confirmDeleteUser({
              id: document.getElementById('modal-user-id').textContent.trim(),
              username: document.getElementById('modal-user-username').textContent.trim(),
              email: document.getElementById('modal-user-email').textContent.trim()
            })" 
            data-bs-toggle="modal" 
            data-bs-target="#deleteUserModal">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="manage-users-edit-form">
            <input type="hidden" name="ssio_id" id="modal-edit-user-id" value="{{ user.ssio_id }}">

            <div class="mb-3">
              <label for="modal-edit-user-fname">First Name</label>
              <input type="text" name="fname" id="modal-edit-user-fname" class="form-control">
            </div>

            <div class="mb-3">
              <label for="modal-edit-user-lname">Last Name</label>
              <input type="text" name="lname" id="modal-edit-user-lname" class="form-control">
            </div>

            <div class="mb-3">
              <label for="modal-edit-user-email">Email</label>
              <input type="email" name="email" id="modal-edit-user-email" class="form-control">
            </div>

            <div class="mb-3">
              <label for="modal-edit-user-role">Role</label>
              <div class="mb-3">
                <label for="modal-edit-user-accesstype" class="form-label">Access Type:</label>
                <select class="form-select" name="role_id" id="modal-edit-user-accesstype">
                  <option value="">Select Access Type</option>
                  <option value="1">Admin</option>
                  <option value="2">User</option>
                </select>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="location.reload()">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="user_edit()">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteUserModalLabel">
            <i class="fas fa-exclamation-triangle"></i> Confirm Deletion
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this user?</p>
          <ul>
            <li><strong>User ID:</strong> <span id="delete-user-id"></span></li>
            <li><strong>Username:</strong> <span id="delete-username"></span></li>
            <li><strong>Email:</strong> <span id="delete-user-email"></span></li>
          </ul>
          <p class="text-danger"><strong>This action cannot be undone.</strong></p>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="location.reload()">Cancel</button>
          <form>
            <input type="hidden" name="ssio_id" id="delete-user-id-input">
            <button type="button" class="btn btn-danger" onclick="user_delete()">Delete User</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.getElementById('users-table');
      const headers = table.querySelectorAll('th');
      let sortDirection = 1; // 1 = asc, -1 = desc
      let currentSortedColumn = -1;
  
      headers.forEach((header, index) => {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => {
              if (currentSortedColumn === index) {
                  sortDirection *= -1; // Toggle direction
              } else {
                  sortDirection = 1; // Default to ascending
                  currentSortedColumn = index;
              }
  
              const tbody = table.querySelector('tbody');
              const rows = Array.from(tbody.querySelectorAll('tr'))
                  .filter(row => row.querySelectorAll('td').length > 0); // Ignore empty or no-data rows
  
              rows.sort((a, b) => {
                  const cellA = a.querySelectorAll('td')[index].innerText.trim().toLowerCase();
                  const cellB = b.querySelectorAll('td')[index].innerText.trim().toLowerCase();
  
                  // Try to compare as numbers first
                  const numA = parseFloat(cellA);
                  const numB = parseFloat(cellB);
  
                  if (!isNaN(numA) && !isNaN(numB)) {
                      return (numA - numB) * sortDirection;
                  }
  
                  return cellA.localeCompare(cellB) * sortDirection;
              });
  
              // Clear existing rows
              rows.forEach(row => tbody.appendChild(row));
          });
      });
  });

  function openViewUserModal(button){
    const dataset = button.dataset;

    document.getElementById('modal-user-id').textContent = dataset.id || '';
    document.getElementById('modal-user-fname').textContent = dataset.fname || '';
    document.getElementById('modal-user-lname').textContent = dataset.lname || '';
    document.getElementById('modal-user-username').textContent = dataset.username || '';
    document.getElementById('modal-user-email').textContent = dataset.email || '';
    document.getElementById('modal-user-access-type').textContent = dataset.accessType || '';
  }

  function confirmDeleteUser(userData){
    document.getElementById('delete-user-id').textContent = userData.id;
    document.getElementById('delete-username').textContent = userData.username;
    document.getElementById('delete-user-email').textContent = userData.email;
    document.getElementById('delete-user-id-input').value = userData.id;

    var deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
    deleteModal.show();
  }

  function openEditUserModal(button) {
    const dataset = button.dataset;

    document.getElementById('modal-edit-user-id').value = dataset.id || '';
    document.getElementById('modal-edit-user-fname').value = dataset.fname || '';
    document.getElementById('modal-edit-user-lname').value = dataset.lname || '';
    document.getElementById('modal-edit-user-email').value = dataset.email || '';
    document.getElementById('modal-edit-user-accesstype').value = dataset.accessType || '';

    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    editModal.show();
  }

  function user_create() {
    const fname = document.getElementById('ssio_fname').value;
    const lname = document.getElementById('ssio_lname').value;
    const email = document.getElementById('ssio_email').value;
    const username = document.getElementById('ssio_username').value;
    const password = document.getElementById('password').value;
    const confPassword = document.getElementById('confirm-password').value;
    const role = document.querySelector('#access_type').value;
    const pin = document.getElementById('ssio_userpin').value;

    if (password !== confPassword) {
      alert('Password Mismatch.');
      return;
    }

    if (fname == "" || lname == "" || email == "" || username == "" || password == "" || role == "" || pin == ""){
      alert('Fill all fields required.');
      return
    }

    const data = {
      fname: fname,
      lname: lname,
      email: email,
      username: username,
      password: password,
      role: role,
      pin: pin
    };

    fetch(`/admin/xu-entry-violation/user/create`, {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => {
          throw new Error(err.message || 'Failed to create user.');
        });
      }
      return response.json();
    })
    .then(result => {
      alert(result.message || 'User created successfully!');
      location.reload();
    })
    .catch(error => {
      alert(`Error: ${error.message}`);
      console.error('User creation error:', error);
    });
  }

  function user_edit() {
    const userId = document.getElementById('modal-edit-user-id').value;
    const fname = document.getElementById('modal-edit-user-fname').value;
    const lname = document.getElementById('modal-edit-user-lname').value;
    const email = document.getElementById('modal-edit-user-email').value;
    const role = document.querySelector('#modal-edit-user-accesstype').value;

    if (fname === "" || lname === "" || email === "" || role === "") {
      alert('Fill all fields required.');
      return;
    }

    const data = {
      user_id: userId,
      fname: fname,
      lname: lname,
      email: email,
      role: role
    };

    fetch(`/admin/xu-entry-violation/user/update/${userId}`, {
      method: "PATCH",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()  
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to update user');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('User updated successfully!');
        window.location.reload();
      } else {
        alert(data.message || 'Something went wrong while updating.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to update user. Please try again.');
    });
  }

  function user_delete() {
    const userId = document.getElementById('delete-user-id-input').value;

    fetch(`/admin/xu-entry-violation/user/delete/${userId}`, {
      method: "DELETE",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ 
        user_id: userId 
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || 'Failed to delete user.');
        });
      }
      return response.json();
    })
    .then(data => {
      alert("User deleted successfully.");
      location.reload();
    })
    .catch(error => {
      alert("Error: " + error.message);
    });
  }

  function getCSRFToken() {
  return document.cookie
    .split(";")
    .find(c => c.trim().startsWith("csrftoken="))
    ?.split("=")[1] || "";
  }
</script>

{% endblock %}